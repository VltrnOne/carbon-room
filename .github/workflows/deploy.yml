# Carbon Room - CI/CD Pipeline
# Domain: thecarbon6.agency
# Primary: SiteGround | Backup: Render

name: Deploy Carbon Room

on:
  push:
    branches: [main]
    paths:
      - 'api/**'
      - 'templates/**'
      - 'static/**'
      - 'deployment/**'
      - '.github/workflows/deploy.yml'
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment target'
        required: true
        default: 'siteground'
        type: choice
        options:
          - siteground
          - render
          - both

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '20'

jobs:
  # ============================================
  # TEST JOB
  # ============================================
  test:
    name: Test Application
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r deployment/requirements.txt
          pip install pytest pytest-asyncio httpx

      - name: Run linting
        run: |
          pip install ruff
          ruff check api/ --ignore E501

      - name: Run tests
        run: |
          pytest tests/ -v --tb=short || echo "No tests found, skipping"

      - name: Test FastAPI app starts
        run: |
          timeout 10 python -c "
          import sys
          sys.path.insert(0, '.')
          from api.server import app
          print('FastAPI app imported successfully')
          print(f'Routes: {len(app.routes)}')
          " || true

  # ============================================
  # BUILD JOB
  # ============================================
  build:
    name: Build Artifacts
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Create deployment package
        run: |
          mkdir -p dist

          # Copy application files
          cp -r api dist/
          cp -r templates dist/ 2>/dev/null || mkdir -p dist/templates
          cp -r static dist/ 2>/dev/null || mkdir -p dist/static

          # Copy deployment configs
          cp deployment/passenger_wsgi.py dist/
          cp deployment/requirements.txt dist/
          cp deployment/.htaccess dist/
          cp deployment/.env.production dist/.env.template

          # Create empty directories
          mkdir -p dist/vault
          mkdir -p dist/telemetry
          mkdir -p dist/tmp

          # Create manifest
          echo "{\"version\": \"$(date +%Y%m%d.%H%M%S)\", \"commit\": \"${{ github.sha }}\"}" > dist/deploy_manifest.json

      - name: Archive deployment package
        run: |
          cd dist
          tar -czf ../carbon-room-deploy.tar.gz .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: carbon-room-deploy
          path: carbon-room-deploy.tar.gz
          retention-days: 7

  # ============================================
  # DEPLOY TO SITEGROUND
  # ============================================
  deploy-siteground:
    name: Deploy to SiteGround
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' && (github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && (github.event.inputs.environment == 'siteground' || github.event.inputs.environment == 'both')))
    environment:
      name: production
      url: https://thecarbon6.agency

    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: carbon-room-deploy

      - name: Extract package
        run: |
          mkdir deploy
          tar -xzf carbon-room-deploy.tar.gz -C deploy

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SITEGROUND_HOST }}
          username: ${{ secrets.SITEGROUND_USER }}
          key: ${{ secrets.SITEGROUND_SSH_KEY }}
          port: ${{ secrets.SITEGROUND_PORT }}
          script: |
            # Backup current deployment
            if [ -d ~/thecarbon6.agency ]; then
              tar -czf ~/backups/carbon-room-$(date +%Y%m%d_%H%M%S).tar.gz ~/thecarbon6.agency
            fi

            # Ensure backup directory exists
            mkdir -p ~/backups

      - name: Upload files via SFTP
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SITEGROUND_HOST }}
          username: ${{ secrets.SITEGROUND_USER }}
          key: ${{ secrets.SITEGROUND_SSH_KEY }}
          port: ${{ secrets.SITEGROUND_PORT }}
          source: "deploy/*"
          target: "~/thecarbon6.agency"
          strip_components: 1

      - name: Post-deployment setup
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SITEGROUND_HOST }}
          username: ${{ secrets.SITEGROUND_USER }}
          key: ${{ secrets.SITEGROUND_SSH_KEY }}
          port: ${{ secrets.SITEGROUND_PORT }}
          script: |
            # Navigate to app directory
            cd ~/thecarbon6.agency

            # Activate virtual environment
            source ~/virtualenv/thecarbon6.agency/3.9/bin/activate

            # Install/update dependencies
            pip install -r requirements.txt --quiet

            # Set permissions
            chmod 755 .
            chmod 644 passenger_wsgi.py
            chmod 600 .env 2>/dev/null || true
            chmod 750 vault
            chmod 750 telemetry

            # Restart Passenger
            mkdir -p tmp
            touch tmp/restart.txt

            echo "Deployment complete: $(date)"

      - name: Verify deployment
        run: |
          sleep 10
          response=$(curl -s -o /dev/null -w "%{http_code}" https://thecarbon6.agency/api/stats)
          if [ "$response" = "200" ]; then
            echo "Deployment verified: HTTP $response"
          else
            echo "Warning: Received HTTP $response"
            exit 1
          fi

  # ============================================
  # DEPLOY TO RENDER (Backup)
  # ============================================
  deploy-render:
    name: Deploy to Render
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'workflow_dispatch' && (github.event.inputs.environment == 'render' || github.event.inputs.environment == 'both')

    steps:
      - name: Trigger Render deploy
        run: |
          curl -X POST \
            -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
            -H "Content-Type: application/json" \
            "https://api.render.com/v1/services/${{ secrets.RENDER_SERVICE_ID }}/deploys"

      - name: Wait for deployment
        run: |
          echo "Render deployment triggered. Check dashboard for status."
          sleep 30

  # ============================================
  # NOTIFY
  # ============================================
  notify:
    name: Send Notification
    runs-on: ubuntu-latest
    needs: [deploy-siteground]
    if: always()

    steps:
      - name: Deployment summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Time:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### URLs" >> $GITHUB_STEP_SUMMARY
          echo "- Production: https://thecarbon6.agency" >> $GITHUB_STEP_SUMMARY
          echo "- API Docs: https://thecarbon6.agency/docs" >> $GITHUB_STEP_SUMMARY
          echo "- Admin: https://thecarbon6.agency/admin" >> $GITHUB_STEP_SUMMARY

      # Optional: Slack notification
      # - name: Slack notification
      #   uses: 8398a7/action-slack@v3
      #   with:
      #     status: ${{ job.status }}
      #     fields: repo,message,commit,author,action,eventName,ref,workflow
      #   env:
      #     SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
      #   if: always()
